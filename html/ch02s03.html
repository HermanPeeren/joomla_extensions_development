<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>3.&nbsp;Web Asset Management</title><link rel="stylesheet" type="text/css" href="html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Joomla Extensions Development"><link rel="up" href="ch02.html" title="Chapter&nbsp;2.&nbsp;Basic concepts"><link rel="prev" href="ch02s02.html" title="2.&nbsp;Dependency Injection Container / Service Locator"><link rel="next" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Components"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3.&nbsp;Web Asset Management</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch02s02.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;2.&nbsp;Basic concepts</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch03.html"><img src="images/next.svg" alt="Next"></a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="concepts-webassetmanager"></a>3.&nbsp;Web Asset Management</h2></div></div></div><p>A large part of our work as Joomla extension developers is to load static assets, CSS and JavaScript files, in the user-facing HTML output of our extensions.</p><p>In older Joomla versions we did that through the HTML document and using HTMLHelper static methods to load dependencies. For example:</p><pre class="programlisting">$doc = \Joomla\CMS\Factory::getApplication()-&gt;getDocument();
Joomla\CMS\HTML\HTMLHelper::_('bootstrap.tooltip', '.hasTooltip');
Joomla\CMS\HTML\HTMLHelper::_('script', 'com_example/something.js', [
	'version'       =&gt; 'auto',
	'relative'      =&gt; true,
	'detectDebug'   =&gt; false,
	'framework'     =&gt; false,
	'pathOnly'      =&gt; false,
	'detectBrowser' =&gt; false,
], [
	'defer' =&gt; true,
	'async' =&gt; false,
]);
</pre><p>This has a few shortcomings, as we have all discovered to our despair.</p><p>First of all, we need to remember to load all dependencies in the correct order before our own CSS or JavaScript file. In the above example, the something.js file depends on Bootstrap's Tooltip helper. If we forget the first call to HTMLHelper our JavaScript file will be broken.</p><p>However, our extension is not the only thing running on the page, right? Now, see the second parameter in that first HTMLHelper call? It tells Joomla's Bootstrap HTML helper to initialise the Tooltip helper so that anything with the class hasTooltip will have a Bootstrap tooltip. Since this is a component we are confident that this will always be the case. Oh, really? If a plugin ran before us and it also loaded its own JavaScript which also depends on Bootstrap's tooltip BUT had no second argument (or a different second argument) do you care to guess what our code above will do? If you guessed &#8220;sod all&#8221; you'd be right and a Joomla extensions development veteran! So, yup, a third party extension having a JavaScript file with the same dependency as ours running before us breaks our perfectly working JavaScript. This could even happen within the same extension if the aforementioned code appeared in a layout and your page just happens to load two layout which both call <code class="code">Joomla\CMS\HTML\HTMLHelper::_('bootstrap.tooltip')</code> with a different second parameter. Great!</p><p>Beyond that, what happens if our something.js gains another dependency and we are loading this file in six different places&#8230; but missed updating one of them? Why, yes, that sixth page will be broken! Even worse, we might only update our code with the additional dependency in one place (let's say a layout), another four places not updated work because they are loading that changed layout and the sixth and final place does not work because it was neither updated nor trying to load something else which loads the dependency for us.</p><p>Let's put it this way. If you do manual dependency management you will be in a world of pain, sooner rather than later.</p><p>Joomla 4 addresses this problem by introducing the Web Asset Manager (WAM). The WAM is responsible for loading our CSS and JavaScript files <span class="emphasis"><em>and their dependencies</em></span>. It can figure out simple dependency chains even across multiple extensions and make sure that things are loaded in an order that makes sense and will do what we wanted it to do.</p><p>For that to work we need two things:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p>Using Joomla's media directory the way it was intended ever since its introduction in Joomla 1.5.0, back in 2007.</p></li><li class="listitem"><p>A <code class="filename">joomla.assets.json</code> file which describes our static assets and their dependencies.</p></li></ol></div><p>On the first point please let me remind you how the media folder works. If you have any static assets which must be web accessible they <span class="bold"><strong>MUST</strong></span> be placed in a subdirectory of the <code class="filename">media</code> folder named after your extension (as Joomla names it internally). Don't put them in your extension's directory, don't put them in <code class="filename">cache</code> or <code class="filename">tmp</code> (they are NOT web accessible, they CAN be moved around even outside the web root AND their contents can and will be removed anytime).</p><p>You have a component named <code class="code">com_foobar</code>? Put your static assets in <code class="filename">media/com_foobar</code>. You have a module named <code class="code">mod_example</code>? Put your static assets in <code class="filename">media/mod_example</code>. You have a plugin named <code class="code">example</code> in the <code class="filename">folder</code> system? Put your static assets in <code class="filename">media/plg_system_example</code>. You have a template named <code class="code">beauty</code>? Put your static assets in <code class="filename">media/tpl_beauty</code>. Its subdirectories are <code class="filename">css</code> for CSS files and <code class="filename">js</code> for JavaScript files. It's simple, it's efficient, it's how Joomla is meant to work.</p><p>The second point, the <code class="filename">joomla.assets.json</code> file, tells Joomla where to find what, what depends on what else and how it all fits together. This file is placed in the extension's media subdirectory.</p><p>For example, a component <code class="code">com_example</code> could have a <code class="filename">media/com_example/joomla.asset.json</code> file which looks like this:</p><pre class="programlisting">{
  "$schema": "https://developer.joomla.org/schemas/json-schema/web_assets.json",
  "name": "com_example",
  "version": "1.0.0",
  "description": "This file contains details of the assets used by the Example component by Acme, Inc.",
  "license": "GPL-2.0-or-later",
  "assets": [
    {
      "name": "com_example.backend",
      "description": "Backend styling.",
      "type": "style",
      "uri": "backend.min.css",
      "dependencies": [
        "com_example.typography"
      ]
    },
    {
      "name": "com_example.typography",
      "description": "Fancy typography.",
      "type": "style",
      "uri": "typography.min.css",
      "dependencies": [
        "fontawesome"
      ]
    },
    {
      "name": "com_example.backend.items",
      "description": "JavaScript for the backend Items page.",
      "type": "script",
      "uri": "backend_items.js",
      "attributes" : {
        "defer": true
      },
      "dependencies": [
        "core"
      ]
    },
    {
      "name": "com_example.backend.items",
      "type": "preset",
      "dependencies": [
        "com_example.backend#style",
        "com_example.backend.items#script"
      ]
    }
  ]
}
</pre><p>We declare various named assets. The <code class="code">com_example.backend</code> style asset loads the <code class="filename">backend.min.css</code> file. However, that file depends on the <code class="code">com_example.typography</code> asset which loads the <code class="filename">typography.min.css</code> file. In its turn, this asset depends on the core <code class="code">fontawesome</code> asset which loads the FontAwesome icon font in any way Joomla figures out is appropriate.</p><p>When we tell Joomla to load the <code class="code">com_example.backend</code> style asset it will first load the CSS files for FontAwesome (if our backend template has not already loaded it), then our <code class="filename">typography.min.css</code> file and finally our <code class="filename">backend.min.css</code> file. This all happens automatically. All we have to do in our extension's template layout code is</p><pre class="programlisting">$this-&gt;document-&gt;getWebAssetManager()-&gt;useStyle('com_example.backend');</pre><p>If at a later point we decide that the backend style needs to depends on yet another CSS asset we will add it to its dependencies array in the <code class="filename">joomla.asset.json</code> file <span class="emphasis"><em>and we are done</em></span>. We do not have to touch our view templates. We do not have to think about anything else. Joomla will figure it out. No more hard to track down bugs!</p><p>You may have noticed that we also declared a script asset called <code class="code">com_example.backend.items</code> which loads the file <code class="filename">backend_items.js</code> deferred. Deferred means that we tell the browser to load it after it has finished initialising the DOM. This means that we do not need to add any special code to execute something after the DOM is initialised which saves us a lot of frustration and bugs. We use the script resource like this:</p><pre class="programlisting">$this-&gt;document-&gt;getWebAssetManager()-&gt;useScript('com_example.backend.items');</pre><p>We have told Joomla that our script only depends on <code class="code">core</code>, i.e. the Joomla core JavaScript. This is not mandatory, but something you will see plenty of times because you'll be using <code class="code">Joomla.getOptions</code> in your JavaScript code to retrieve settings <a class="link" href="ch03s20.html" title="20.&nbsp;Passing data from the backend to the JavaScript on the page">passed from the backend to the frontend</a>. This is the recommended method instead of setting arbitrary JavaScript variables in inline JavaScript code. In fact, using inline JavaScript code is discouraged (but not forbidden) in Joomla 4 and later.</p><p>If at a later point we modify our JavaScript to also depend on Bootstrap's Modal dialog helper we will just update its dependencies:</p><pre class="programlisting">    {
      "name": "com_example.backend.items",
      "description": "JavaScript for the backend Items page.",
      "type": "script",
      "uri": "backend_items.js",
      "attributes" : {
        "defer": true
      },
      "dependencies": [
        "core",
        "bootstrap.modal"
      ]
    }</pre><p>That's it! No more hunting down usages of this JavaScript file and updating our view template code.</p><p>You can of course tell Joomla to load both CSS and JavaScript assets. The simplest way is being descriptive in our view template:</p><pre class="programlisting">$this-&gt;document-&gt;getWebAssetManager()
  -&gt;useStyle('com_example.backend')
  -&gt;useScript('com_example.backend.items');</pre><p>(note that useStyle and useScript return the WAM object which means they can be chain-called)</p><p>However, this runs the same risk as loading assets the old-fashioned way. What happens if we decide that the Items page needs some extra CSS which does not apply to the rest of our component's backend? We'd have to edit the template layout file. Enter bugs.</p><p>Instead of being descriptive we can be <span class="emphasis"><em>prescriptive</em></span> using another WAM feature called <span class="bold"><strong>presets</strong></span>. A preset consists entirely of dependencies. We declared it in our JSON file like this:</p><pre class="programlisting">    {
      "name": "com_example.backend.items",
      "type": "preset",
      "dependencies": [
        "com_example.backend#style",
        "com_example.backend.items#script"
      ]
    }
</pre><p>and we can load it in our view template very easily like this:</p><pre class="programlisting">$this-&gt;document-&gt;getWebAssetManager()-&gt;usePreset('com_example.backend.items');</pre><p>Note that the preset asset's key is the same as our script asset's key. Script, style and preset assets are separate collections which means we <span class="emphasis"><em>can</em></span> reuse the same key across them. Joomla will not be confused. We tell it which collection to look into by using a different WAM method: <code class="code">useScript</code>, <code class="code">useStyle</code> or <code class="code">usePreset</code>.</p><p>Now let's see why presets are the bee's knees. Let's say we decided that Items also needs some special styling in a separate CSS file called <code class="filename">items.min.css</code>. We will just add this asset to our JSON file and update the preset:</p><pre class="programlisting">    {
      "name": "com_example.backend.items",
      "description": "Backend styling just for the Items page.",
      "type": "style",
      "uri": "items.min.css",
      "dependencies": [
        "com_example.backend"
      ]
    },
    {
      "name": "com_example.backend.items",
      "type": "preset",
      "dependencies": [
        "com_example.backend#style",
        "com_example.backend.items#style",
        "com_example.backend.items#script"
      ]
    }
</pre><p>(You may notice that our <code class="code">com_example.backend.items</code> asset depends on <code class="code">com_example.backend</code>. I didn't have to do that, but I like to be explicit about dependencies to avoid any stupid bugs if I remove any intermediate dependencies in a dependency chain.)</p><p>We do NOT have to touch our view template file. Since we are telling it to load a preset, changing the preset is enough for Joomla to figure out what it needs to do.</p><p>Using the Web Asset Manager correctly can be a massive asset (no pun intended!) in your extensions' public frontend. Your view templates can load your prescriptive presets. If you decide you want to change something you can change the preset. Your clients who have created template overrides will NOT need to update their overrides. This means far fewer &#8220;bug&#8221; reports and more time for you to work on your code.</p><p>The Web Asset Manager has changed the way I write extensions and has solved a lot of my headaches. You can use the WAM on any component running on Joomla 4, regardless of whether you are using the &#8220;old&#8221; (Joomla 3) MVC or the &#8220;new&#8221; (Joomla 4) MVC. In fact, since it is a part of the Joomla document object, you can use it in modules, even plugins &#8212; however, if you are using it in a plugin you MUST tell the WAM to load your JSON file since Joomla will not do that by default for plugins.</p><p>Finally, the WAM is a much less error-prone method to injecting static assets to Joomla. All Joomla document classes have a WAM, even when they are not HTML; it just follows that if it's a non-HTML document adding an asset through WAM does nothing. Compare that with what happens if you try to use the HTMLHelper or the addScript / addStyle document methods when your document is not HTML. Yup, these old ways of adding static assets cause Joomla to error out. Again, WAM is safe, the methods of yesteryear are not. One more reason to migrate your extensions to WAM today.</p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch02s02.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch02.html"><img src="images/up.svg" alt="Up"></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch03.html"><img src="images/next.svg" alt="Next"></a></td></tr><tr><td width="40%" align="left" valign="top">2.&nbsp;Dependency Injection Container / Service Locator&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.svg" alt="Home"></a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;3.&nbsp;Components</td></tr></table></div></body></html>