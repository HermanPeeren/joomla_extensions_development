<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>11.&nbsp;Controllers</title><link rel="stylesheet" type="text/css" href="html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Joomla Extensions Development"><link rel="up" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Components"><link rel="prev" href="ch03s10.html" title="10.&nbsp;Models"><link rel="next" href="ch03s12.html" title="12.&nbsp;Views"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">11.&nbsp;Controllers</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s10.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;3.&nbsp;Components</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch03s12.html"><img src="images/next.svg" alt="Next"></a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="com-controllers"></a>11.&nbsp;Controllers</h2></div></div></div><p>The bulk of the implementation logic for Joomla 4 MVC Controllers is the same as in Joomla 3 MVC.</p><p>The logic is that most views are displayed using the component's <code class="code">DisplayController</code> which extends from Joomla's <code class="code">Joomla\CMS\MVC\Controller\BaseController</code>. You only write custom controllers when there's an action needed or when you need access to a Form object.</p><div class="tip"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The kind of MVC practiced by Joomla and described above is a bit &#8220;dirty&#8221;; all views share a common DisplayController for displaying. This is fine with Joomla's one-trick-pony components, only able to display one kind of information.</p><p>When you have something more complex this may not be at all convenient. For example, a document management system might need separate views to display nested categories, available items (including the actual <span class="emphasis"><em>downloading</em></span> part!) and uploading items, as well as viewing, adding and managing comments per document. In these cases it's typically much more efficient to have a separate controller per view. In components like that each view consists of a Controller, Model and View class (an MVC triad) which is more in line with how the normative MVC coding pattern is meant to work. This is perfectly possible in Joomla <span class="emphasis"><em>as long as you have a custom Dispatcher</em></span>. You can see how I am doing that <a class="link" href="https://github.com/akeeba/release-system/blob/development/component/backend/src/Dispatcher/Dispatcher.php" target="_top">in the Dispatcher of Akeeba Release System</a>, the software downloads management software used by Joomla's official Downloads site.</p></td></tr></table></div><p>The Controller classes extend from one of the base Joomla MVC Controller super-classes:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Joomla\CMS\MVC\Controller\BaseController</span></dt><dd><p>The most basic controller you can get. It is mainly used to power the <code class="code">DisplayController</code> of the component or whenever you want to create custom controllers to display stuff and perform non-administrative actions (e.g. in the frontend).</p><div class="warning"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Heads up! In Joomla 3 the default display controller was in the root of the component as the file <code class="filename">controller.php</code> e.g. <code class="filename">administrator/components/com_example/controller.php</code>. This is no longer the case in Joomla 4 and later. All controllers are under the <code class="filename">src/Controller</code> folder and the default controller is named <code class="code">DisplayController</code> which means that in the above example it would be located in <code class="filename">administrator/components/com_example/srs/Controller/DisplayController.php</code>.</p><p>In Joomla 4 and later the <code class="code">DisplayController</code> is mostly empty except for a line like this:</p><pre class="programlisting">protected $default_view = 'foobar';</pre><p>This is the name of the &#8220;default view&#8221;. That's the view which will be displayed if the <em class="parameter"><code>view</code></em> URL parameter is not provided in the request.</p></td></tr></table></div></dd><dt><span class="term">\Joomla\CMS\MVC\Controller\AdminController</span></dt><dd><p>This is an extension to BaseController. It is meant for displaying list views in the backend of your site, e.g. a list of articles.</p><div class="tip"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This is the controller you will be typically using for controllers whose name is <span class="bold"><strong>plural</strong></span> such as <code class="code">\Acme\Example\Administrator\Controller\ItemsController</code>. Since this is the Items controller and &#8220;items&#8221; is plural it gives us a hint that it will be displaying multiple items which, in the Joomla backend, is very likely to be a list.</p><p>A mnemonic way to remember this is PASiFIC (yes, with the misspelling and all) "Plural Admin Singular Form Identifies the Controller".</p></td></tr></table></div><p>It also handles <span class="bold"><strong>some</strong></span> of the admin tasks you will have to perform on records in a Joomla list view: publish, unpulish, archive, trash, report, orderup, orderdown, delete, reorder, saveorder, checkin, checkout, saveOrderAjax and runTransition. Everything else has to be handled by a singular named Controller which extends FormController. Yes, that's confusing and yes, it's the source of many bugs &#8212; but that's the same as Joomla 3 and earlier so at least it's <span class="emphasis"><em>consistently confusing</em></span>.</p></dd><dt><span class="term">\Joomla\CMS\MVC\Controller\FormController</span></dt><dd><p>This is an extension to the BaseController which additionally implements Form handling. This is meant to be used in views which add or edit a database record. Additionally, it will be used in views which handle an XML Form e.g. a configuration page.</p><div class="tip"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This is the controller you will be typically using for controllers whose name is <span class="bold"><strong>singular</strong></span> such as <code class="code">\Acme\Example\Administrator\Controller\ItemController</code>. Since this is the Item controller and &#8220;item&#8221; is singular it gives us a hint that it will be displaying a single item which, in the Joomla backend, is very likely to be an add / edit record page.</p><p>In the frontend of the site you may have <span class="bold"><strong>two</strong></span> controllers for the same data type. One DisplayController extending from BaseController to display the item and one singular name controller extending from FormController to add or edit an item. It <span class="emphasis"><em>is</em></span> possible to have a single controller, extending from FormController. You see, FormController itself extends from BaseController which has the display method which is used to display stuff, i.e. it already contains the functionality of the typical DisplayController.</p></td></tr></table></div></dd><dt><span class="term">\Joomla\CMS\MVC\Controller\ApiController</span></dt><dd><p>This is a very special kind of controller which is only used in the <a class="link" href="ch03s24.html" title="24.&nbsp;The API application">JSON API application part of your component</a> e.g. the code under <code class="filename">api/components/com_example</code>.</p><p>This type of controller does not have a direct equivalent in the other controllers. It can do everything. Produce a list of records, return a single record, create a new record and modify or delete an existing record.</p></dd></dl></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="com-controllers-basic-services"></a>11.1.&nbsp;Basic services in your Controller</h3></div></div></div><p>A Controller object created by Joomla has a few basic services. In the olden days before Joomla 4 we had to use static methods in <code class="code">\Joomla\CMS\Factory</code> (formerly <code class="code">JFactory</code>) or the base MVC objects themselves to get access to these services. You are no longer supposed to do that, you are supposed to use the services provided in the Controller object itself.</p><h4><a name="d0e3342"></a>Application</h4><p>In Joomla 3 and earlier we would get the currently active application object through <code class="code">\Joomla\CMS\Factory::getApplication()</code>. Do NOT do that.</p><p>In Joomla 4 and later you can get the currently active application object through <code class="code">$this-&gt;app</code>.</p><p>Please remember that the application you are getting is not necessarily a <code class="code">SiteApplication</code> or <code class="code">AdministratorApplication</code>. It may very well be an <code class="code">ApiApplication</code> (JSON API), a <code class="code">ConsoleApplication</code> (Joomla CLI app) or even a custom application extending from <code class="code">\Joomla\CMS\Application\CMSApplication</code>.</p><h4><a name="d0e3371"></a>Dispatcher</h4><p>In Joomla 3 and earlier you'd run plugin events by doing something like this:</p><pre class="programlisting">$results = \Joomla\CMS\Factory::getApplication()
  -&gt;triggerEvent('onSomething', [$param1, $param2]);</pre><p>In Joomla 4 and later there are two ways to call plugin events.</p><p>The first method is the legacy method, going through the application's <code class="code">triggerEvent</code> method, which is discouraged and will eventually go away.</p><pre class="programlisting">$results = $this-&gt;app-&gt;triggerEvent('onSomething', [$param1, $param2]);</pre><p>The second and recommended method is going through the Joomla events dispatcher and using real events.</p><pre class="programlisting">$event = \Joomla\CMS\Event\GenericEvent::create('onSomething', [$param1, $param2]);
$this-&gt;getDispatcher()-&gt;dispatch($event-&gt;getName(), $event);
$results = $event-&gt;getArgument('result', []);</pre><p>While this looks a bit more complicated it has some benefits.</p><p>Using Events to access plugins means that you get access to a <a class="link" href="ch04s07.html" title="7.&nbsp;Generic versus Concrete events">concrete event object</a>. All core Joomla events will correspond to concrete event objects in Joomla 5.0, meaning that you will be able to add typehinting and have your IDE (e.g. phpStorm, Visual Studio Code, NetBeans, Eclipse, ...) auto-complete the argument names when manipulating an event.</p><p>The real Events implemented in Joomla 4 and later, unlike plain old plugin handlers we had in Joomla 1.0 to 3.10, can prevent some of their arguments to be modified, prescribe exactly <span class="emphasis"><em>what</em></span> can be modified and even allow plugins to stop the processing of an event when we reach a point that further processing is unnecessary. If you slowly move from just using custom event names to concrete event classes you can implement far more complex features in your code with much less code &#8212; believe me, I've been there and done that! Event handling is one of those fundamental things which you are <span class="emphasis"><em>really</em></span> upset it's changed but once you start getting the idea of how the new system works you start wondering how you could have ever written software without it.</p><h4><a name="d0e3405"></a>Input</h4><p>Back in the olden days we'd get the user's input by doing one of these (the more of these you remember the older you are &#8212; some date back to the early 00s!):</p><pre class="programlisting">// Joomla 1.0
$foo = \JRequest::getCmd('foo');
// Joomla 1.5
$input = new \Joomla\CMS\Input\Input();
$foo = $input-&gt;getCmd('foo');
// Joomla 1.6
$foo = Joomla\CMS\Factory::getApplication()-&gt;input-&gt;getCmd('foo');</pre><p>This had always been a bad idea because our Controller had to <span class="emphasis"><em>know</em></span> about the global application object and its request variables. This meant, for example, that we could not reuse our component to display a view <a class="link" href="ch03s27.html" title="27.&nbsp;HMVC (sort of)">using HMVC</a>.</p><p>Since Joomla 3.0 the Controller object has an <code class="code">input</code> property which holds its own <code class="code">\Joomla\CMS\Input\Input</code> object. In Joomla 3 this was typically just the application's input object unless you were manually constructing a controller (with a lot of effort).</p><p>In Joomla 4.0 and later the input property contains its own \Joomla\CMS\Input\Input object <span class="emphasis"><em>which comes from the DI Container of the component</em></span>. Remember that when booting a component we get access to its <a class="link" href="ch03s06.html" title="6.&nbsp;Extension class">component extension object</a> which has access to the component's <a class="link" href="ch02s02.html" title="2.&nbsp;Dependency Injection Container / Service Locator">DI Container</a>. This of course means that we can add <a class="link" href="ch03s06.html#com-extension-dic-proxy" title="6.4.&nbsp;Getting access to the component's DIC anytime, anywhere">a method to that object to access the DI Container</a> and set a custom input object, thereby implementing HMVC very easily &#8212; something that Joomla core maintainers didn't think was possible with the core architecture a few years ago! This means that whenever we want to create a module which displays the same information an existing view of our component already does, albeit in a slightly different format, all we need to do is create a new view template or layout and use HMVC, without having to rewrite our business logic in the module. We can write less code to do more. That's awesome!</p><p>That is (one of the many reasons) why you should <span class="emphasis"><em>always</em></span> be accessing the input as <code class="code">$this-&gt;input</code> in your controllers. Now you know.</p><h4><a name="d0e3449"></a>MVCFactory</h4><p>Back in Joomla 1.0 to 3.10 creating an MVC object such as a Model, View, Table, or even another Controller from inside our Controller required calling static methods in the base MVC objects or proxy methods in the controller, like so:</p><pre class="programlisting">$someController = \Joomla\CMS\MVC\Controller\BaseController::getInstance('Some');
$someModel = \Joomla\CMS\MVC\Model\BaseDatabaseModel::getInstance('Some', 'ExampleModel');
// or
$someModel = $this-&gt;createModel('Some', 'ExampleModel');
$someView = $this-&gt;createView('Some', 'ExampleView', 'Html');
$someTable = \Joomla\CMS\Table\Table::getInstance('Some', 'ExampleTable');</pre><p>There are two things which strike us as suboptimal:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>There is no consistency in how you create MVC objects. Some are static calls, some are method calls to proxy functions.</p></li><li class="listitem"><p>There is no consistency in the arguments you provide. Creating a controller only needs its name (and requires the magic configuration array key <code class="code">base_path</code> if you want to get a controller from a component other than the current one), creating anything else requires us to give it the prefix of the MVC class name (not just the component name).</p></li></ul></div><p>This is what we'd call &#8220;sanity came here to die&#8221;.</p><p>Joomla 3.10 introduced the MVCFactory for creating models, views and tables and Joomla 4.0 extended it by also letting it create controllers. See how easier and more consistent everything is now:</p><pre class="programlisting">// Only on Joomla 4.0 and later
$someController = $this-&gt;getMVCFactory()-&gt;createController('Some', 'Administrator');
// Joomla 3.10 and later
$someModel = $this-&gt;getMVCFactory()-&gt;createModel('Some', 'Administrator');
$someView = $this-&gt;getMVCFactory()-&gt;createView('Some', 'Administrator', 'Html');
$someTable = $this-&gt;getMVCFactory()-&gt;createTable('Some', 'Administrator');
// Inside the Controller I can still do this (4.0 and later):
$someModel = $this-&gt;getModel('Some', 'Administrator');
$someView = $this-&gt;getView('Some', 'Administrator', 'Html');</pre><p>First of all, we see that creating MVC objects is now very consistent and easier.</p><p>Second, we notice that the <code class="code">$prefix</code> argument is no longer something component-specific (such as <code class="code">ExampleModel</code>) but simply the side of the application (Site, Administrator or Api) that we want to get the MVC object from.</p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Tables are only available in the Administrator side of the application. While you can theoretically defined different Table classes in the frontend (Site) or JSON API (Api) side it's not a good idea as you will very likely run into issues where the &#8220;wrong&#8221; table class is being used. As a result, it's advisable to always call <code class="code">createTable</code> with two parameters and set the second parameter to <code class="option">Administrator</code>).</p></td></tr></table></div><p>Legacy Joomla 3 components still work despite the apparent backwards compatibility (b/c) break in the <code class="code">getModel</code> and <code class="code">getView</code> methods. Why is that? Well, it's because Joomla 4 uses the <code class="code">\Joomla\CMS\MVC\Factory\LegacyFactory</code> instead of <code class="code">\Joomla\CMS\MVC\Factory\MVCFactory</code> for these components. The LegacyFactory is aware of the b/c break and acts accordingly so you, the extensions developer, do not suffer. This is possible because each component has its own DI Container. So that's another way how using a DI Container allowed Joomla to create an updated, richer MVC API without breaking backwards compatibility with Joomla 3 &#8212; at least until Joomla 6.0. Neat, huh?</p><p>As a developer, you should remember this when you are inside a Controller writing code:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>If you want to get a Model or View use the controller's <code class="code">getModel</code> and <code class="code">getView</code> methods.</p></li><li class="listitem"><p>If you want to get another <code class="code">Controller</code> or a <code class="code">Table</code> do not instantiate them directly! Always go through the MVCFactory.</p></li><li class="listitem"><p>The second argument to all these methods is the application side you are getting an object from. Leave it empty to use the <span class="emphasis"><em>current</em></span> application side or pass an explicit value. If you leave it empty keep in mind that, for example, your backend controller may be running in the frontend. In this case, do you <span class="emphasis"><em>really</em></span> want to get the frontend model?</p></li></ul></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s10.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch03.html"><img src="images/up.svg" alt="Up"></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch03s12.html"><img src="images/next.svg" alt="Next"></a></td></tr><tr><td width="40%" align="left" valign="top">10.&nbsp;Models&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.svg" alt="Home"></a></td><td width="40%" align="right" valign="top">&nbsp;12.&nbsp;Views</td></tr></table></div></body></html>