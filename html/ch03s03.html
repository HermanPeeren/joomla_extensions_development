<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>3.&nbsp;The lifetime of a component</title><link rel="stylesheet" type="text/css" href="html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Joomla Extensions Development"><link rel="up" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Components"><link rel="prev" href="ch03s02.html" title="2.&nbsp;Joomla 3 MVC vs Joomla 4 MVC"><link rel="next" href="ch03s04.html" title="4.&nbsp;Directory structure"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3.&nbsp;The lifetime of a component</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s02.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;3.&nbsp;Components</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch03s04.html"><img src="images/next.svg" alt="Next"></a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="com-lifetime"></a>3.&nbsp;The lifetime of a component</h2></div></div></div><p>In the previous section we talked about the new concepts in the Joomla 4 MVC but it's really hard to understand how they all work together. It's best if we talk about the lifetime of a component, i.e. what happens when you try to access a Joomla URL in the form <code class="uri">index.php?option=com_example&amp;view=foo</code>.</p><p>The lifetime of our component starts in the application object (<code class="code">SiteApplication</code>, <code class="code">AdministratorApplication</code> or <code class="code">ApiApplication</code>), namely its <code class="code">dispatch()</code> method. All these methods do some initialisation and call <code class="code">Joomla\CMS\Component::renderComponent()</code>. This method runs this line where things get interesting for our component:</p><pre class="programlisting">$app-&gt;bootComponent($option)-&gt;getDispatcher($app)-&gt;dispatch();</pre><p>Let's rewrite it so it's more readable:</p><pre class="programlisting">$componentExtension = $app-&gt;bootComponent($option)
$componentDispatcher = $componentExtension-&gt;getDispatcher($app)
$componentDispatcher-&gt;dispatch();</pre><p>What Joomla does is ask the application object to <span class="emphasis"><em>somehow</em></span> get a component extension object &#8212; even if it is a legacy component using the Joomla 3 MVC. Then it asks the component extension object to get it the component's Dispatcher object. Finally, it tells the component's Dispatcher to dispatch (execute) the component.</p><p>These three steps are crucial to understanding the difference between legacy Joomla 3 MVC components, modern Joomla 4 MVC components and how Joomla 4 makes them all work.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="com-lifetime-booting"></a>3.1.&nbsp;Booting the component</h3></div></div></div><p>The <code class="code">bootComponent</code> method is implemented by <code class="code">Joomla\CMS\Extension\ExtensionManagerTrait</code>. The first thing it does, by calling its <code class="code">loadExtension</code> method, is to figure out if this is a Joomla 4 MVC or Joomla 3 MVC component. It does that by looking for the <code class="filename">services/provider.php</code> file under the component's root. As you may have guessed this is our component's <a class="link" href="ch03s05.html" title="5.&nbsp;Service provider">service provider</a> and the reason why all Joomla 4 MVC components, even the simplest ones for which we could infer their service provider, really do need to have a service provider file.</p><p>If the file exists it's loaded and its services are registered into the copy of the Joomla DIC which is used as our component's DIC.</p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This means that our component only sees a frozen in time copy of the global application services. You cannot register any services in the component's DIC and expect them to be available in the global application.</p></td></tr></table></div><p>If the file does not exist, Joomla creates an instance of the <code class="code">Joomla\CMS\Extension\LegacyComponent</code>. As you can see, this extension object uses a legacy MVC factory object which "speaks" the Joomla 3 non-namespaced MVC class names and a legacy component dispatcher which looks for the <code class="filename">componentName.php</code> (in our example: <code class="filename">example.php</code>) component entry point file and loads it. This is exactly how Joomla 4 can render components using Joomla 3 MVC.</p><p>The rest of this section will talk about a Joomla 4 MVC component.</p><p>Finally, Joomla returns <a class="link" href="ch03s06.html" title="6.&nbsp;Extension class">the component's extension object</a> as the result of the <code class="code">bootComponent</code> method.</p><div class="tip"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>You can call <code class="code">\Joomla\CMS\Factory::getApplication()-&gt;bootComponent('com_example')</code> to get the <code class="code">com_example</code> component's extension object anytime, anywhere &#8212; <span class="bold"><strong>including in modules and plugins</strong></span>. If you subclass the <code class="code">Joomla\CMS\Extension\MVCExtension</code> class in your own component you can create your own methods to return <span class="emphasis"><em>ANY OBJECT KNOWN TO THE COMPONENT AND ITS CONTAINER</em></span>.</p><p>This is of enormous importance.</p><p>You can instantiate any MVC class of the component. You have access to your HTML helper, categories service and router service. You can get an instance of any of the custom services you created in your component. All of that WITHOUT any static helpers in your extension, WITHOUT worrying that something might break if you call your code outside your component. Your Models can provide a public API for third party developers communicating with your component.</p><p>Joomla core components already do that. For example, you can get the backend <code class="code">ArticleModel</code> of <code class="code">com_content</code> in a frontend component or plugin to create a new Joomla article <span class="emphasis"><em>the right way</em></span>:</p><pre class="programlisting">$articleModel = \Joomla\CMS\Factory::getApplication()
  -&gt;bootComponent('com_content')
  -&gt;getMVCFactory()
  -&gt;createModel('Article', 'Administrator');</pre></td></tr></table></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="com-lifetime-dispatcher"></a>3.2.&nbsp;Getting the Dispatcher</h3></div></div></div><p>The extension object is responsible for returning a number of interesting objects through its methods. These objects are meant to be used for interacting with the component. One of these is <code class="code">getDispatcher</code> which lets us retrieve the component's <a class="link" href="ch03s07.html" title="7.&nbsp;Dispatcher">Dispatcher</a> object.</p><p>Your extension can have a custom dispatcher class, <code class="code">\My\Prefix\Dispatcher\Dispatcher</code>, where <code class="code">\My\Prefix</code> is your component's prefix. If this class exists, an object instance of it is returned.</p><p>If your extension does not have a dispatcher an instance of the default <code class="code">Joomla\CMS\Dispatcher\ComponentDispatcher</code> (site and administrator applications) or <code class="code">Joomla\CMS\Dispatcher\ApiDispatcher</code> (API application) will be created and returned instead.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="com-lifetime-dispatching"></a>3.3.&nbsp;Dispatching the component</h3></div></div></div><p>The dispatcher object has a <code class="code">dispatch()</code> method. This method looks in the request data to figure out which controller it needs to instantiate and which task it should execute on it. The controller object is instantiated through your component's <code class="code">MVCFactory</code> service and its <code class="code">execute</code> and <code class="code">redirect</code> methods are called on it. So, yes, this is basically what your old Joomla 3 MVC <code class="filename">controller.php</code> file was doing.</p><div class="tip"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Having a custom dispatcher means that you can manipulate the <span class="emphasis"><em>controller and task</em></span> based on other request variables.</p><p>This is very important when your component is accessed <span class="emphasis"><em>outside of a Joomla menu item (no Itemid in the request variables)</em></span>. In this case Joomla always uses the default (Home) menu item for the current language. This means that you may be getting a <code class="uri">controller</code>, <code class="uri">view</code> or <code class="uri">task</code> request variable &#8212; as well as other variables which might mess with your component, like <code class="uri">id</code> &#8212; from the Home menu item.</p><p>Your Dispatcher is responsible for figuring out if this is the case and fix the input variables to prevent weird bugs / showing the wrong page of your component when it's accessed without a menu item id, e.g. a URL like <code class="uri">/component/example?view=foobar</code>. This is something which has happened a lot when I converted my own extensions to Joomla 4, including LoginGuard (the extension contributed as Joomla's Multi-factor Authentication feature in Joomla 4.2).</p></td></tr></table></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s02.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch03.html"><img src="images/up.svg" alt="Up"></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch03s04.html"><img src="images/next.svg" alt="Next"></a></td></tr><tr><td width="40%" align="left" valign="top">2.&nbsp;Joomla 3 MVC vs Joomla 4 MVC&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.svg" alt="Home"></a></td><td width="40%" align="right" valign="top">&nbsp;4.&nbsp;Directory structure</td></tr></table></div></body></html>