<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>18.&nbsp;The installation script</title><link rel="stylesheet" type="text/css" href="html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Joomla Extensions Development"><link rel="up" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Components"><link rel="prev" href="ch03s17.html" title="17.&nbsp;Dashboard"><link rel="next" href="ch03s19.html" title="19.&nbsp;Component menus"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">18.&nbsp;The installation script</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s17.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;3.&nbsp;Components</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch03s19.html"><img src="images/next.svg" alt="Next"></a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="com-installation-script"></a>18.&nbsp;The installation script</h2></div></div></div><p>We touched a bit on the installation script when talking about <a class="link" href="ch03s17.html" title="17.&nbsp;Dashboard">Dashboards</a>. But what is an installation script?</p><p>When Joomla is installing an extension it gives us, the developers of the extension, the opportunity to run some custom PHP code at different phases of the installer execution using the different methods provided in our installer script (you can see all available methods in the <code class="interfacename">\Joomla\CMS\Installer\InstallerScriptInterface</code> interface):</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">public function preflight(string $type, InstallerAdapter $adapter): bool;</span></dt><dd><p>Runs before the component is installed, updated or uninstalled.</p><p>This is where you make basic environment checks and make sure that the installer can proceed. Return boolean false to stop the installer, causing to display an error like &#8220;Extension <em class="replaceable"><code>something</code></em>: Custom install routine failure.&#8221;</p></dd><dt><span class="term">public function install(InstallerAdapter $adapter): bool;</span></dt><dd><p>Runs after your extension has been installed. This only happens on a clean installation, i.e. your extension was not previously installed.</p><p>This is where you can run code which only applies to a clean installation, e.g. publishing modules and plugins necessary for your component to work.</p></dd><dt><span class="term">public function update(InstallerAdapter $adapter): bool;</span></dt><dd><p>Runs after your extension has been updated.</p><div class="warning"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>&#8220;Updated&#8221; is a term used <span class="emphasis"><em>very loosely</em></span> by Joomla. It merely means that a different version than the one which was previously installed on the site has been installed. It might be <span class="emphasis"><em>the same</em></span> version (refresh) or even an earlier version (downgrade).</p></td></tr></table></div></dd><dt><span class="term">public function uninstall(InstallerAdapter $adapter): bool;</span></dt><dd><p>Runs after your extension has been successfully uninstalled.</p><p>Use this to perform any necessary cleanup which could not be performed by Joomla removing the files and folders of your extension and running the uninstallation SQL files.</p></dd><dt><span class="term">public function postflight(string $type, InstallerAdapter $adapter): bool;</span></dt><dd><p>This runs at the very last end, before Joomla cleans up. It runs after the extension has been installed, updated or uninstalled.</p></dd></dl></div><p>In the above methods you can see one or two parameters:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">string $type</span></dt><dd><p>Whenever present it tells us which kind of operation is taking place:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="code">install</code>. The extension is being installed from a package uploaded via the browser, a package downloaded from an HTTP/HTTPS source, the Install via Web feature or from a directory. This is a normal installation from scratch. The extension had not been previously installed.</p></li><li class="listitem"><p><code class="code">discover_install</code>. The extension is being installed using the Discover feature. This means that the files are already placed on the site but there's no guarantee that some files are not missing! Also note that you cannot install a package extension like that. If your component is part of a package it should return <code class="code">false</code> in the preflight method to prevent a broken, non-updatable installation of your component to persist on the site.</p></li><li class="listitem"><p><code class="code">update</code>. Another version of your extension (NOT necessarily older!) was already installed on the site and the user is trying to install a different version.</p></li><li class="listitem"><p><code class="code">uninstall</code>. Your extension is being uninstalled.</p></li></ul></div></dd><dt><span class="term">InstallerAdapter $adapter</span></dt><dd><p>This is an instance of the <code class="classname">\Joomla\CMS\Installer\InstallerAdapter</code> subclass handling the installation, update or uninstallation of your extension. For components, that's actually an instance of the <code class="classname">\Joomla\CMS\Installer\Adapter\ComponentAdapter</code> class.</p></dd></dl></div><p>To use an installation script you have to declare it in your extension's XML manifest. For example:</p><pre class="programlisting">&lt;scriptfile&gt;script.example.php&lt;/scriptfile&gt;</pre><p>The file must be included with your extension's XML manifest at the archive's root.</p><p>The <code class="code">script.example.php</code> file will contain our extension installation script. You are familiar with that; it's been around since Joomla 1.0.</p><p>Since Joomla 3.6 there's a superclass our installation script can extend from. In Joomla 3 it was called <code class="classname">JInstallerScript</code>, in Joomla 4 it's <code class="classname">Joomla\CMS\Installer\InstallerScript</code> (the old name will work up to and including Joomla 5.3). When your script extends from this class you can unlock a lot of useful functionality.</p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This class is actually a fork of the <a class="link" href="https://github.com/akeeba/fof/blob/fof-2.x/fof/utils/installscript/installscript.php" target="_top">F0FUtilsInstallscript class</a> I had introduced in FOF since 2014 and maintained until 2021, when FOF officially became obsolete and I moved all my development to Joomla core MVC. The fork was contributed by George Wilson in 2016 &#8212; he had already asked me for permission to fork some useful bits of FOF 2 as it was going to be EOL in June that year. Just an aside, so that you know that Joomla and 3PDs have a symbiotic relationship; <span class="emphasis"><em>we help each other survive</em></span>.</p></td></tr></table></div><h3><a name="d0e5428"></a>Minimum Joomla and PHP versions</h3><p>The installation script can automatically enforce a minimum Joomla and / or PHP version for your extension. If the minimum requirements are not met the installation or upgrade will abort with the aforementioned error. You can do that by setting the relevant properties in your class:</p><pre class="programlisting">// The extension will only install on PHP 8.0.0 or later
protected $minimumPhp = '8.0.0';

// The extension will only install on Joomla 4.2.0 or later
protected $minimumJoomla = '4.2.0';</pre><h3><a name="d0e5434"></a>Handling downgrades</h3><p>As mentioned earlier, Joomla uses the term &#8220;upgrade&#8221; very loosely. If you install any version of your extension while another (or the same!) version is already installed Joomla will happily oblige and call it an &#8220;upgrade&#8221;. However, most extensions cannot <span class="emphasis"><em>downgrade</em></span> cleanly, i.e. going from version 2.0.0 to version 1.9.3 may not work at all. This makes perfect sense. You cannot possibly travel back in time to update the installation script of your extension's older versions to make a downgrade possible &#8212; if it's even at all possible. Therefore, <span class="bold"><strong>by default, the installation script will prevent downgrades</strong></span>. Users can only install the same or a newer version of your software.</p><div class="warning"><table border="0" summary="Warning"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Warning]" src="images/warning.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Preventing downgrades will only work properly if your extension uses <a class="link" href="https://semver.org" target="_top">Semantic Versioning (SemVer)</a>. Your development / nightly releases must additionally follow <a class="link" href="https://www.php.net/manual/en/function.version-compare.php" target="_top">PHP's versioning rules</a>. That is to say, a development / nightly release coming after the official release of version 1.2.3 must be named something like 1.2.<span class="bold"><strong>4</strong></span>-dev-20220914.</p></td></tr></table></div><p>There are cases where you might not want to do that. Simpler extensions may support downgrades, or you may have implemented some solution which allows you to perform downgrades (e.g. you may have added a custom file in every new release to handle downgrades to a previous version). Or you may just not use semantic versioning and you'd rather implement your custom logic to determine when something is a downgrade or not. In this case set this in your installer class:</p><pre class="programlisting">protected $allowDowngrades = true;</pre><h3><a name="d0e5460"></a>Removing obsolete folders and files</h3><p>As we progress through versions of our software we have to contend with the fact that some code becomes obsolete and needs to be removed, Joomla has changed leading to moved files, or we might even need to refactor code and move things around. This means that we have files and folders which need to be removed on upgrade.</p><p>Joomla will automatically remove folders and files explicitly listed in the XML manifest of the installed version but not on the new version's XML manifest. This means that only, for example, top level component folders are removed on update. If you have a few specific files, e.g. some obsolete view template files, or folders deeper inside the directory structure they will not be automatically removed.</p><p>The $deleteFiles and $deleteFolders properties allow you to specify which files and folders need to be removed, if they exist, on update. For example:</p><pre class="programlisting">protected $deleteFiles = [
  JPATH_SITE . '/components/com_example/tmpl/welcome/default_donate.php',
  JPATH_ADMINISTRATOR . '/components/com_example/tmpl/item/default_phpwarning.php',
];

protected $deleteFolders = [
  JPATH_SITE . '/media/com_example/icons',
];</pre></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s17.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch03.html"><img src="images/up.svg" alt="Up"></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch03s19.html"><img src="images/next.svg" alt="Next"></a></td></tr><tr><td width="40%" align="left" valign="top">17.&nbsp;Dashboard&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.svg" alt="Home"></a></td><td width="40%" align="right" valign="top">&nbsp;19.&nbsp;Component menus</td></tr></table></div></body></html>