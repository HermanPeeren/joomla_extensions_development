<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>22.&nbsp;Mail Templates</title><link rel="stylesheet" type="text/css" href="html.css"><meta name="generator" content="DocBook XSL Stylesheets V1.79.1"><link rel="home" href="index.html" title="Joomla Extensions Development"><link rel="up" href="ch03.html" title="Chapter&nbsp;3.&nbsp;Components"><link rel="prev" href="ch03s21.html" title="21.&nbsp;Language files"><link rel="next" href="ch03s23.html" title="23.&nbsp;The CLI application"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">22.&nbsp;Mail Templates</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ch03s21.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;3.&nbsp;Components</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="ch03s23.html"><img src="images/next.svg" alt="Next"></a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="com-mailtemplates"></a>22.&nbsp;Mail Templates</h2></div></div></div><p>Joomla 4 introduced a new core component, Mail Templates (<code class="code">com_mails</code>). You can access it from the System dashboard.</p><p>This component allows you to manage email templates used by the different components which make use of Joomla's new Mail Templates feature. The user can choose to customise the plain text email's contents or even provide a full HTML email &#8212; or both. This is a much better user experience than language overrides, especially when it comes to HTML email.</p><p>Using this feature is recommended, but not required. If you decide to use it for your components there's a bit of trouble you need to get through.</p><h3><a name="d0e6460"></a>Installing mail templates</h3><p>Mail templates live in the database, in the <span class="database">#__mail_templates</span> table. The fields for each mail template are as follows:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="database">template_id</span></span></dt><dd><p>The unique identifier of your mail template in the form <code class="code">com_example.<em class="replaceable"><code>something</code></em></code> where <code class="code">com_example</code> is your component and <em class="replaceable"><code>something</code></em> is a key consisting of just lowercase alphanumeric characters and underscores (a-z, 0-9 and _). This is a hard requirement; language string keys will be created using the <span class="database">template_id</span>. This ID is what you will use when you want to send emails with this email template.</p></dd><dt><span class="term"><span class="database">language</span></span></dt><dd><p>The language tag of the mail template, e.g. <code class="code">en-GB</code> for British English.</p><div class="important"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/important.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The default mail template should have an empty string as its language to apply to all languages. This is very different from literally everything else in Joomla which uses a <code class="code">*</code> as the catch-all language.</p></td></tr></table></div></dd><dt><span class="term"><span class="database">subject</span></span></dt><dd><p>The language string with the subject line of the email. The content of the language string can use variables (see <span class="database">params</span> below).</p></dd><dt><span class="term"><span class="database">body</span></span></dt><dd><p>The language string with the body of the plain text version of the email. The content of the language string can use variables (see <span class="database">params</span> below).</p></dd><dt><span class="term"><span class="database">htmlbody</span></span></dt><dd><p>The language string with the body of the HTML version of the email. The content of the language string can use variables (see <span class="database">params</span> below).</p></dd><dt><span class="term"><span class="database">attachments</span></span></dt><dd><p></p></dd><dt><span class="term"><span class="database">extension</span></span></dt><dd><p>The name of your extension, e.g. <code class="code">com_example</code>.</p><div class="note"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>You may wonder, if my template_id already contains this why is this a separate column? You are right, it doesn't make sense. Joomla could have just used an index on the template_id column with the same performance results or, if it was actually concerned about performance, use the numeric extension ID in this column. It doesn't make anysense; it is what it is.</p></td></tr></table></div></dd><dt><span class="term"><span class="database">params</span></span></dt><dd><p>A JSON-serialised object with the parameters to the mail template. What is most important for us is its <code class="code">tags</code> property. For example, you may have this <span class="database">params</span> content:</p><pre class="programlisting">{
  "tags": [
    "FOO", "BAR", "BAZ"
  ]
}</pre><p>This tells Mail Templates that you can use the variables <code class="code">{FOO}</code>, <code class="code">{BAR}</code> and <code class="code">{BAZ}</code> in the subject, body and HTML body of the mail templates &#8212; and let users know that in the user interface. When sending e-mails via the Mail Templates feature you will have to provide the values for these variables. The variable names MUST always consist of uppercase letters, dashes, underscores and colons.</p></dd></dl></div><p>Moreover, you will need to supply a few language strings in you backend INI language file (e.g. <code class="filename">administrator/languages/en-GB/com_example.ini</code>).</p><p>You need to provide a language string whose key is the uppercase version of your extension name, e.g.</p><pre class="programlisting">COM_EXAMPLE="Example component"</pre><p>This is used in the Mail Templates drop-down for selecting a component to filter by.</p><p>For each email template you will need to provide a few &#8220;magic&#8221; language strings <span class="emphasis"><em>on top of</em></span> the language strings you defined in the <span class="database">subject</span>, <span class="database">body</span>, and <span class="database">htmlbody</span> columns. Assuming a <span class="database">template_id</span> <code class="code">com_example.foo_bar</code> you will need to provide the following language strings:</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><code class="code"><em class="replaceable"><code>COM_EXAMPLE</code></em>_MAIL_<em class="replaceable"><code>FOO_BAR</code></em>_TITLE</code></span></dt><dd><p>A long title for your email template, displayed in the user interface. The content of this language string should be something similar to &#8220;My Component Name: When This Mail Template Is Sent&#8221;.</p></dd><dt><span class="term"><code class="code"><em class="replaceable"><code>COM_EXAMPLE</code></em>_MAIL_<em class="replaceable"><code>FOO_BAR</code></em>_SHORT</code></span></dt><dd><p>A short title for your email template. I am not sure when this is used.</p></dd><dt><span class="term"><code class="code"><em class="replaceable"><code>COM_EXAMPLE</code></em>_MAIL_<em class="replaceable"><code>FOO_BAR</code></em>_DESC</code></span></dt><dd><p>A short description of your email template, displayed in the user interface.</p></dd></dl></div><h3><a name="d0e6648"></a>Using mail templates</h3><p>The Mail Templates feature does NOT send e-mails. It only provides you with a pre-configured Joomla Mailer object you will use to send e-mails with.</p><p>This is how you use it:</p><pre class="programlisting">/**
 * @var string $templateId The template ID you want to use, e.g. com_example.foo_bar
 * @var string $langTag The language tag for your email, e.g. 'en-GB'
 */
$template = new \Joomla\CMS\Mail\MailTemplate($templateId, $langTag);

// Add the contents of your variables here
$template-&gt;addTemplateData([
	'FOO' =&gt; 'Contents of the {FOO} variable',
	'BAR' =&gt; 'Contents of the {BAR} variable',
	'BAZ' =&gt; 'Contents of the {BAZ} variable',
]);

/**
 * @var string $emailAddress The email address of the recipient, e.g. jane@example.com
 * @var string $recipientName The full name of your recipient, e.g. "Jane Doe"
 */
$template-&gt;addRecipient($emailAddress, $recipientName);

// Send the email
$template-&gt;Send();</pre><p>If you want to customise the Joomla Mailer object used by the <code class="classname">MailTemplate</code> class &#8212;for example to set custom headers, add inline images or attachments which cannot be handled by MailTemplate, etc&#8212; you can pass it as the third parameter to its constructor, e.g.</p><pre class="programlisting">$mailer = \Joomla\CMS\Factory::getMailer();
$mailer-&gt;addCustomHeader('X-Vanity-Header', 'Joomla! Rocks');

$template = new \Joomla\CMS\Mail\MailTemplate($templateId, $langTag, $mailer);</pre><p>Do keep in mind that each email template may have its own configuration about the sender address and sending method (e.g. SMTP information). These settings will override the same settings in your custom mailer object when you call <code class="methodname">Send()</code>.</p><div class="tip"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.svg"></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The above will error out if MailTemplate cannot find a suitable template. You can check if a suitable template exists by doing this before any of the code above:</p><pre class="programlisting">$template = Joomla\CMS\Mail\MailTemplate::getTemplate($templateId, $langTag);</pre><p>If $template is empty do NOT go through MailTemplate. You can simply not send the email, provide an alternative, throw an error or otherwise handle this condition in a way appropriate for your application.</p></td></tr></table></div><h3><a name="d0e6675"></a>Caveats</h3><p>Users can, and <span class="emphasis"><em>will</em></span>, mess up the Mail Templates. If they just mess up the subject, plain text body or HTML body they can recover easily by using the respective reset button in the user interface.</p><p>If they create a specific language version of a mail template they cannot remove it without messing with the database.</p><p>If you update a mail template, adding more tags (variables) in its parameters you will need to write update SQL which updates all entries with the relevant template_id <span class="bold"><strong>BUT</strong></span> you should note that by overwriting the contents of the <span class="database">params</span> column you will be resetting the user's preferences about the mailer itself (sender, sending method, credentials etc). Therefore updating mail templates <span class="emphasis"><em>actually</em></span> requires writing PHP code in your extension's installation script to run on update, read all mail templates with the affected <span class="database">template_id</span>, decode the <span class="database">params</span>, update the tags and write everything back to the database. It's a big old pain in the posterior.</p><p>A final word of caution. The MailTemplate class has some static methods such as <code class="methodname">createTemplate</code> and <code class="methodname">updateTemplate</code>. <span class="bold"><strong>Don't use them</strong></span>. They will error out.</p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch03s21.html"><img src="images/prev.svg" alt="Prev"></a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="ch03.html"><img src="images/up.svg" alt="Up"></a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="ch03s23.html"><img src="images/next.svg" alt="Next"></a></td></tr><tr><td width="40%" align="left" valign="top">21.&nbsp;Language files&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html"><img src="images/home.svg" alt="Home"></a></td><td width="40%" align="right" valign="top">&nbsp;23.&nbsp;The CLI application</td></tr></table></div></body></html>